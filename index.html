<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScopeX ¬∑ Professional Excel Estimator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #f5f7fa 0%, #e9eef5 100%);
            font-family: 'Plus Jakarta Sans', sans-serif;
            color: #1a2b3e;
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 2rem;
            flex-wrap: wrap;
            gap: 20px;
            background: white;
            border-radius: 24px;
            padding: 1rem 2rem;
            box-shadow: 0 10px 30px -10px rgba(0, 0, 0, 0.1);
            border: 1px solid #eef2f6;
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo-icon {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            width: 56px;
            height: 56px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2rem;
            box-shadow: 0 10px 20px -5px rgba(99, 102, 241, 0.3);
        }

        .title h1 {
            font-weight: 800;
            font-size: 2rem;
            background: linear-gradient(135deg, #1e293b, #0f172a);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: -0.02em;
        }

        .title p {
            font-weight: 500;
            font-size: 0.9rem;
            color: #64748b;
            margin-top: 4px;
        }

        .project-badge {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 40px;
            font-weight: 600;
            font-size: 1rem;
            box-shadow: 0 10px 20px -5px rgba(16, 185, 129, 0.3);
            max-width: 400px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-info-bar {
            background: white;
            border-radius: 20px;
            padding: 1.5rem 2rem;
            margin-bottom: 2rem;
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            align-items: flex-end;
            border: 1px solid #eef2f6;
        }

        .project-field {
            flex: 1;
            min-width: 250px;
        }

        .project-field label {
            display: block;
            font-weight: 600;
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .project-field input {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .project-field input:focus {
            border-color: #6366f1;
            outline: none;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .estimator-grid {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 24px;
            margin-bottom: 30px;
        }

        @media (max-width: 1200px) {
            .estimator-grid { grid-template-columns: 1fr; }
        }

        .card {
            background: white;
            border-radius: 32px;
            padding: 32px;
            box-shadow: 0 20px 40px -15px rgba(0, 0, 0, 0.1);
            border: 1px solid #eef2f6;
        }

        .result-card {
            background: linear-gradient(135deg, #1e293b, #0f172a);
            border-radius: 32px;
            padding: 32px;
            color: white;
            box-shadow: 0 20px 40px -15px rgba(0, 0, 0, 0.3);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 28px;
            border-bottom: 2px solid #eef2f6;
            padding-bottom: 20px;
        }

        .card-header i {
            font-size: 1.8rem;
            color: #6366f1;
        }

        .card-header h2 {
            font-weight: 700;
            font-size: 1.4rem;
            color: #1e293b;
        }

        .result-card .card-header {
            border-bottom-color: rgba(255, 255, 255, 0.1);
        }

        .result-card .card-header h2 {
            color: white;
        }

        .result-card .card-header i {
            color: #fbbf24;
        }

        .input-row {
            display: flex;
            flex-direction: column;
            margin-bottom: 22px;
        }

        .input-row label {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 8px;
            color: #475569;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-row input, .input-row select {
            background: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 14px 18px;
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 1rem;
            transition: all 0.2s;
        }

        .input-row input:focus, .input-row select:focus {
            border-color: #6366f1;
            outline: none;
            box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1);
        }

        .row-flex {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .conditional-section {
            background: #f8fafc;
            border-radius: 24px;
            padding: 24px;
            margin: 24px 0 16px;
            border: 2px dashed #cbd5e1;
        }

        .section-tag {
            background: linear-gradient(135deg, #6366f1, #8b5cf6);
            color: white;
            padding: 6px 16px;
            border-radius: 40px;
            font-size: 0.8rem;
            font-weight: 700;
            display: inline-block;
            margin-bottom: 20px;
            letter-spacing: 0.05em;
        }

        .hidden {
            display: none;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 24px;
        }

        .hours-big {
            font-size: 5rem;
            font-weight: 800;
            line-height: 1;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hours-label {
            font-size: 1rem;
            opacity: 0.7;
            font-weight: 500;
        }

        .tier-tag {
            padding: 8px 24px;
            border-radius: 40px;
            font-weight: 700;
            font-size: 1.1rem;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(5px);
        }

        .dual-hours {
            display: flex;
            gap: 20px;
            margin: 28px 0;
        }

        .dual-hours-item {
            flex: 1;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 24px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        .dual-hours-item .label {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-bottom: 10px;
        }

        .dual-hours-item .value {
            font-size: 3rem;
            font-weight: 800;
            line-height: 1;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .dual-hours-item .subtext {
            font-size: 0.75rem;
            opacity: 0.5;
            margin-top: 8px;
        }

        .executive-summary {
            background: rgba(251, 191, 36, 0.1);
            border-radius: 20px;
            padding: 20px;
            margin: 24px 0;
            border-left: 6px solid #fbbf24;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .flag {
            padding: 16px 20px;
            border-radius: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
            font-weight: 500;
        }

        .flag.critical {
            background: rgba(239, 68, 68, 0.1);
            border-left: 6px solid #ef4444;
        }

        .flag.warning {
            background: rgba(251, 191, 36, 0.1);
            border-left: 6px solid #fbbf24;
        }

        .flag i {
            font-size: 1.3rem;
        }

        .recommendation-box {
            background: rgba(16, 185, 129, 0.1);
            border-radius: 20px;
            padding: 24px;
            margin: 24px 0;
            border-left: 6px solid #10b981;
        }

        .recommendation-box strong {
            color: #10b981;
            display: block;
            margin-bottom: 12px;
            font-size: 1.1rem;
        }

        .recommendation-box ul {
            margin-left: 20px;
            color: rgba(255, 255, 255, 0.9);
        }

        .recommendation-box li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        .btn {
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            border: none;
            border-radius: 40px;
            padding: 18px 32px;
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            width: 100%;
            color: #1e293b;
            transition: all 0.3s;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 30px -10px rgba(251, 191, 36, 0.3);
        }

        footer {
            margin-top: 40px;
            text-align: center;
            color: #64748b;
            font-size: 0.9rem;
        }

        .placeholder-text {
            opacity: 0.6;
            font-style: italic;
        }
    </style>
</head>
<body>
<div class="container">
    <div class="header">
        <div class="logo-area">
            <div class="logo-icon">
                <i class="fas fa-compass"></i>
            </div>
            <div class="title">
                <h1>ScopeX</h1>
                <p>Statement of Work Estimator</p>
            </div>
        </div>
        <div class="project-badge" id="projectBadge">
            <i class="fas fa-pen" style="margin-right: 8px;"></i>
            <span id="projectDisplay">Enter project details below</span>
        </div>
    </div>

    <div class="project-info-bar">
        <div class="project-field">
            <label><i class="fas fa-file-signature"></i> PROJECT NAME</label>
            <input type="text" id="projectName" placeholder="e.g., Acme Corporation Implementation" oninput="updateProjectDisplay()">
        </div>
        <div class="project-field">
            <label><i class="fas fa-align-left"></i> PROJECT DESCRIPTION</label>
            <input type="text" id="projectDescription" placeholder="e.g., Global lease accounting rollout" oninput="updateProjectDisplay()">
        </div>
    </div>

    <div class="estimator-grid">
        <div class="card">
            <div class="card-header">
                <i class="fas fa-sliders-h"></i>
                <h2>Project configuration</h2>
            </div>

            <div class="input-row">
                <label><i class="fas fa-building"></i> Company codes</label>
                <input type="number" id="cocos" min="1" placeholder="e.g., 5" oninput="calculate()">
            </div>
            
            <div class="input-row">
                <label><i class="fas fa-chart-pie"></i> Asset classes</label>
                <input type="number" id="assetClasses" min="1" placeholder="e.g., 6" oninput="calculate()">
            </div>
            
            <div class="input-row">
                <label><i class="fas fa-file-contract"></i> Contract volume</label>
                <input type="number" id="contracts" min="1" placeholder="e.g., 1500" oninput="calculate()">
            </div>

            <div class="row-flex">
                <div class="input-row">
                    <label><i class="fas fa-balance-scale"></i> Determination</label>
                    <select id="determination" onchange="calculate()">
                        <option value="">‚Äî Select ‚Äî</option>
                        <option value="Standard">Standard (20 hrs)</option>
                        <option value="Custom">Custom (40 hrs)</option>
                    </select>
                </div>
                <div class="input-row">
                    <label><i class="fas fa-globe"></i> Accounting</label>
                    <select id="gaap" onchange="calculate()">
                        <option value="">‚Äî Select ‚Äî</option>
                        <option value="Single">Single (20 hrs)</option>
                        <option value="Dual">Dual (40 hrs)</option>
                        <option value="Triple">Triple (60 hrs)</option>
                    </select>
                </div>
            </div>

            <div class="card-header" style="margin-top: 15px;">
                <i class="fas fa-database"></i>
                <h2>Data readiness</h2>
            </div>

            <div class="input-row">
                <label><i class="fas fa-source"></i> Primary data source</label>
                <select id="dataSource" onchange="toggleMigrationSection(); calculate()">
                    <option value="">‚Äî Select source ‚Äî</option>
                    <option value="templates">üìÅ Nakisa Native Templates</option>
                    <option value="pdf">üìÑ PDF Extraction</option>
                    <option value="excel">üìä Excel Export</option>
                    <option value="migration">üõ†Ô∏è Migration Tool</option>
                </select>
            </div>

            <div id="standardDataSection" style="display: none;">
                <div class="row-flex">
                    <div class="input-row">
                        <label><i class="fas fa-check-circle"></i> Template readiness</label>
                        <select id="templateReadiness" onchange="calculate()">
                            <option value="">‚Äî Select ‚Äî</option>
                            <option value="ready">Ready to load (1.0x)</option>
                            <option value="needsConversion">Needs conversion (1.5x)</option>
                        </select>
                    </div>
                    <div class="input-row">
                        <label><i class="fas fa-broom"></i> Data quality</label>
                        <select id="dataQuality" onchange="calculate()">
                            <option value="">‚Äî Select ‚Äî</option>
                            <option value="clean">Clean (1.0x)</option>
                            <option value="needsCleansing">Needs cleansing (1.3x)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="migrationSection" class="conditional-section hidden">
                <div class="section-tag"><i class="fas fa-tools"></i> MIGRATION TOOL READINESS</div>
                
                <div class="input-row">
                    <label><i class="fas fa-cog"></i> Tool state</label>
                    <select id="toolState" onchange="calculate()">
                        <option value="">‚Äî Select ‚Äî</option>
                        <option value="mature">‚úÖ Mature - ready to use</option>
                        <option value="needsConfig">‚öôÔ∏è Needs configuration</option>
                        <option value="notReady">‚ö†Ô∏è NOT ready - PS defines strategy</option>
                        <option value="none">üö´ No tool - build from scratch</option>
                    </select>
                </div>

                <div class="input-row">
                    <label><i class="fas fa-cubes"></i> Entities to migrate</label>
                    <input type="number" id="entityCount" min="1" placeholder="e.g., 15" oninput="calculate()">
                </div>

                <div class="input-row">
                    <label><i class="fas fa-code-branch"></i> Transformation complexity</label>
                    <select id="transformComplexity" onchange="calculate()">
                        <option value="">‚Äî Select ‚Äî</option>
                        <option value="low">üìâ Low (10-20% need logic)</option>
                        <option value="medium">üìä Medium (30-50% need logic)</option>
                        <option value="high">üìà High (50%+ need complex logic)</option>
                    </select>
                </div>
            </div>

            <div class="card-header" style="margin-top: 15px;">
                <i class="fas fa-users-cog"></i>
                <h2>Team enablement</h2>
            </div>

            <div class="row-flex">
                <div class="input-row">
                    <label><i class="fas fa-user-tie"></i> Dedicated PM</label>
                    <select id="clientPm" onchange="calculate()">
                        <option value="">‚Äî Select ‚Äî</option>
                        <option value="yes">Yes (1.0x)</option>
                        <option value="no">No (1.1x)</option>
                    </select>
                </div>
                <div class="input-row">
                    <label><i class="fas fa-chart-line"></i> Change management</label>
                    <select id="clientChange" onchange="calculate()">
                        <option value="">‚Äî Select ‚Äî</option>
                        <option value="yes">Yes (1.0x)</option>
                        <option value="no">No (1.2x)</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="result-card">
            <div class="result-header">
                <div>
                    <div class="hours-label">total estimated effort</div>
                    <div class="hours-big" id="totalHours">‚Äî</div>
                    <div class="hours-label">person-hours</div>
                </div>
                <div class="tier-tag" id="riskLevel">PENDING</div>
            </div>

            <div class="dual-hours">
                <div class="dual-hours-item">
                    <div class="label">core project</div>
                    <div class="value" id="coreProjectHours">‚Äî</div>
                    <div class="subtext">base + volume + complexity</div>
                </div>
                <div class="dual-hours-item">
                    <div class="label">additional effort</div>
                    <div class="value" id="additionalEffort">‚Äî</div>
                    <div class="subtext">data readiness + migration</div>
                </div>
            </div>

            <div class="executive-summary" id="executiveSummary">
                <span class="placeholder-text">Configure project parameters above</span>
            </div>

            <div class="risk-flags" id="riskFlags"></div>

            <div class="recommendation-box" id="recommendations" style="display: none;"></div>

            <div class="button-group">
                <button class="btn" id="excelBtn">
                    <i class="fas fa-file-excel"></i>
                    Download Excel Analysis
                </button>
            </div>
        </div>
    </div>

    <footer>
        ¬© 2024 ScopeX. All rights reserved.
    </footer>
</div>

<script>
    function updateProjectDisplay() {
        const projectName = document.getElementById('projectName').value;
        const projectDesc = document.getElementById('projectDescription').value;
        const badge = document.getElementById('projectDisplay');
        
        if (projectName && projectDesc) {
            badge.innerHTML = `${projectName} ¬∑ ${projectDesc}`;
        } else if (projectName) {
            badge.innerHTML = projectName;
        } else if (projectDesc) {
            badge.innerHTML = projectDesc;
        } else {
            badge.innerHTML = 'Enter project details below';
        }
    }

    const BASE_HOURS = {
        platform: 40,
        projectMgmt: 30,
        architecture: 30,
        total: 100
    };

    const RATES = {
        perCompanyCode: 2,
        perAssetClass: 2,
        per100Contracts: 5
    };

    const COMPLEXITY = {
        determination: { Standard: 20, Custom: 40 },
        accounting: { Single: 20, Dual: 40, Triple: 60 }
    };

    const DATA_READINESS = {
        template: { ready: 1.0, needsConversion: 1.5 },
        quality: { clean: 1.0, needsCleansing: 1.3 }
    };

    function calculateStrategyHours(toolState, entityCount, complexity) {
        if (!toolState || !entityCount || !complexity) return 0;
        
        const count = parseInt(entityCount) || 0;
        if (count === 0) return 0;
        
        if (toolState === 'mature') return 0;
        if (toolState === 'needsConfig') return 80;
        
        let basePerEntity = 0;
        if (toolState === 'notReady') basePerEntity = 35;
        if (toolState === 'none') basePerEntity = 60;
        
        let complexityMultiplier = 1.0;
        if (complexity === 'medium') complexityMultiplier = 1.5;
        if (complexity === 'high') complexityMultiplier = 2.2;
        
        let entityMultiplier = 1.0;
        if (count > 20) entityMultiplier = 1.3;
        if (count > 50) entityMultiplier = 1.6;
        
        const strategyHours = Math.round(
            count * basePerEntity * complexityMultiplier * entityMultiplier
        );
        
        const overhead = toolState === 'none' ? 200 : 120;
        return strategyHours + overhead;
    }

    function getExecutionMultiplier(toolState) {
        if (toolState === 'mature') return 1.0;
        if (toolState === 'needsConfig') return 1.3;
        if (toolState === 'notReady') return 2.2;
        if (toolState === 'none') return 3.0;
        return 1.0;
    }

    function getSourceMultiplier(dataSource) {
        if (dataSource === 'pdf') return 1.5;
        if (dataSource === 'excel') return 1.2;
        return 1.0;
    }

    window.toggleMigrationSection = function() {
        const dataSource = document.getElementById('dataSource').value;
        const standardSection = document.getElementById('standardDataSection');
        const migrationSection = document.getElementById('migrationSection');
        
        if (dataSource === 'migration') {
            standardSection.style.display = 'none';
            migrationSection.classList.remove('hidden');
        } else if (dataSource === 'templates' || dataSource === 'pdf' || dataSource === 'excel') {
            standardSection.style.display = 'block';
            migrationSection.classList.add('hidden');
        } else {
            standardSection.style.display = 'none';
            migrationSection.classList.add('hidden');
        }
    };

    function calculate() {
        const cocos = document.getElementById('cocos').value;
        const assets = document.getElementById('assetClasses').value;
        const contracts = document.getElementById('contracts').value;
        const determination = document.getElementById('determination').value;
        const gaap = document.getElementById('gaap').value;
        const dataSource = document.getElementById('dataSource').value;
        const clientPm = document.getElementById('clientPm').value;
        const clientChange = document.getElementById('clientChange').value;
        
        const cocosNum = cocos ? parseInt(cocos) : 0;
        const assetsNum = assets ? parseInt(assets) : 0;
        const contractsNum = contracts ? parseInt(contracts) : 0;
        
        let coreHours = 0;
        let hasBasicInputs = false;
        let breakdownItems = [];
        
        // Base platform
        coreHours = BASE_HOURS.total;
        breakdownItems.push({
            item: 'Base Platform',
            hours: BASE_HOURS.total,
            description: 'Platform setup, project management, architecture'
        });
        
        if (cocosNum > 0 || assetsNum > 0 || contractsNum > 0 || determination || gaap) {
            hasBasicInputs = true;
            
            if (cocosNum > 0) {
                const hrs = cocosNum * RATES.perCompanyCode;
                coreHours += hrs;
                breakdownItems.push({
                    item: `${cocosNum} Company Code${cocosNum > 1 ? 's' : ''}`,
                    hours: hrs,
                    description: `${cocosNum} legal entities at ${RATES.perCompanyCode} hrs each`
                });
            }
            if (assetsNum > 0) {
                const hrs = assetsNum * RATES.perAssetClass;
                coreHours += hrs;
                breakdownItems.push({
                    item: `${assetsNum} Asset Class${assetsNum > 1 ? 'es' : ''}`,
                    hours: hrs,
                    description: `${assetsNum} asset types at ${RATES.perAssetClass} hrs each`
                });
            }
            if (contractsNum > 0) {
                const hrs = Math.ceil(contractsNum / 100) * RATES.per100Contracts;
                coreHours += hrs;
                breakdownItems.push({
                    item: `${contractsNum.toLocaleString()} Contracts`,
                    hours: hrs,
                    description: `${Math.ceil(contractsNum / 100)} groups of 100 contracts at ${RATES.per100Contracts} hrs each`
                });
            }
            if (determination) {
                const hrs = COMPLEXITY.determination[determination] || 0;
                coreHours += hrs;
                breakdownItems.push({
                    item: `${determination} Determination`,
                    hours: hrs,
                    description: determination === 'Standard' ? 'Standard out-of-box logic' : 'Custom mapping rules'
                });
            }
            if (gaap) {
                const hrs = COMPLEXITY.accounting[gaap] || 0;
                coreHours += hrs;
                breakdownItems.push({
                    item: `${gaap} Accounting`,
                    hours: hrs,
                    description: gaap === 'Single' ? 'Single standard' : gaap === 'Dual' ? 'IFRS + US GAAP' : 'Three+ standards'
                });
            }
        }
        
        document.getElementById('coreProjectHours').innerText = coreHours > 0 ? coreHours.toLocaleString() : '‚Äî';
        
        if (!hasBasicInputs) {
            document.getElementById('totalHours').innerText = '‚Äî';
            document.getElementById('additionalEffort').innerText = '‚Äî';
            document.getElementById('executiveSummary').innerHTML = '<span class="placeholder-text">Configure project parameters above</span>';
            document.getElementById('riskFlags').innerHTML = '';
            document.getElementById('recommendations').style.display = 'none';
            document.getElementById('riskLevel').innerText = 'PENDING';
            return;
        }

        let totalHours = coreHours;
        let additionalEffort = 0;
        let riskFlags = [];
        let multiplierDetails = [];
        let strategyHours = 0;
        
        if (dataSource === 'migration') {
            const toolState = document.getElementById('toolState').value;
            const entityCount = document.getElementById('entityCount').value;
            const transformComplexity = document.getElementById('transformComplexity').value;
            
            if (!toolState || !entityCount || !transformComplexity) {
                document.getElementById('totalHours').innerText = '‚Äî';
                document.getElementById('additionalEffort').innerText = '‚Äî';
                document.getElementById('executiveSummary').innerHTML = '<span class="placeholder-text">Complete migration tool selections</span>';
                return;
            }
            
            const entityCountNum = parseInt(entityCount) || 0;
            strategyHours = calculateStrategyHours(toolState, entityCount, transformComplexity);
            
            const executionMultiplier = getExecutionMultiplier(toolState);
            
            let teamMultiplier = 1.0;
            if (clientPm === 'no') teamMultiplier *= 1.1;
            if (clientChange === 'no') teamMultiplier *= 1.2;
            
            // Calculate the impact of each multiplier in hours
            const baseForMultipliers = coreHours;
            const afterExecution = Math.round(baseForMultipliers * executionMultiplier);
            const executionImpact = afterExecution - baseForMultipliers;
            
            const afterTeam = Math.round(afterExecution * teamMultiplier);
            const teamImpact = afterTeam - afterExecution;
            
            const executionHours = afterTeam;
            totalHours = executionHours + strategyHours;
            additionalEffort = totalHours - coreHours;
            
            // Add multiplier details
            multiplierDetails.push({
                item: `Execution Multiplier (${toolState})`,
                hours: executionImpact,
                description: `${executionMultiplier.toFixed(1)}x multiplier due to tool state`
            });
            
            if (teamMultiplier > 1.0) {
                multiplierDetails.push({
                    item: 'Team Multiplier',
                    hours: teamImpact,
                    description: `${teamMultiplier.toFixed(2)}x due to PM/change management gaps`
                });
            }
            
            multiplierDetails.push({
                item: 'Migration Strategy',
                hours: strategyHours,
                description: `Strategy definition for ${entityCountNum} entities with ${transformComplexity} complexity`
            });
            
            if (toolState === 'notReady') {
                riskFlags.push({ type: 'critical', text: `Migration tool not ready - requires ${strategyHours} hrs strategy for ${entityCountNum} entities` });
            } else if (toolState === 'none') {
                riskFlags.push({ type: 'critical', text: `No migration tool - custom build: ${strategyHours} hrs design` });
            }
            
        } else if (dataSource === 'templates' || dataSource === 'pdf' || dataSource === 'excel') {
            const templateReadiness = document.getElementById('templateReadiness').value;
            const dataQuality = document.getElementById('dataQuality').value;
            
            if (!templateReadiness || !dataQuality) {
                document.getElementById('totalHours').innerText = '‚Äî';
                document.getElementById('additionalEffort').innerText = '‚Äî';
                document.getElementById('executiveSummary').innerHTML = '<span class="placeholder-text">Complete data readiness selections</span>';
                return;
            }
            
            const templateMult = DATA_READINESS.template[templateReadiness];
            const qualityMult = DATA_READINESS.quality[dataQuality];
            const sourceMultiplier = getSourceMultiplier(dataSource);
            
            let teamMultiplier = 1.0;
            if (clientPm === 'no') teamMultiplier *= 1.1;
            if (clientChange === 'no') teamMultiplier *= 1.2;
            
            // Calculate cumulative impact
            let currentHours = coreHours;
            
            const afterSource = Math.round(currentHours * sourceMultiplier);
            const sourceImpact = afterSource - currentHours;
            currentHours = afterSource;
            
            const afterTemplate = Math.round(currentHours * templateMult);
            const templateImpact = afterTemplate - currentHours;
            currentHours = afterTemplate;
            
            const afterQuality = Math.round(currentHours * qualityMult);
            const qualityImpact = afterQuality - currentHours;
            currentHours = afterQuality;
            
            const afterTeam = Math.round(currentHours * teamMultiplier);
            const teamImpact = afterTeam - currentHours;
            
            totalHours = afterTeam;
            additionalEffort = totalHours - coreHours;
            
            // Add multiplier details with actual hour impacts
            if (sourceMultiplier > 1.0) {
                multiplierDetails.push({
                    item: `Data Source (${dataSource === 'pdf' ? 'PDF' : 'Excel'})`,
                    hours: sourceImpact,
                    description: `${sourceMultiplier.toFixed(1)}x multiplier for ${dataSource === 'pdf' ? 'manual PDF extraction' : 'Excel data mapping'}`
                });
            }
            
            if (templateMult > 1.0) {
                multiplierDetails.push({
                    item: 'Template Conversion',
                    hours: templateImpact,
                    description: `${templateMult.toFixed(1)}x multiplier for converting data to Nakisa templates`
                });
            }
            
            if (qualityMult > 1.0) {
                multiplierDetails.push({
                    item: 'Data Cleansing',
                    hours: qualityImpact,
                    description: `${qualityMult.toFixed(1)}x multiplier for cleaning source data`
                });
            }
            
            if (teamMultiplier > 1.0) {
                multiplierDetails.push({
                    item: 'Team Constraints',
                    hours: teamImpact,
                    description: `${teamMultiplier.toFixed(2)}x multiplier due to ${clientPm === 'no' ? 'no PM, ' : ''}${clientChange === 'no' ? 'no change management' : ''}`
                });
            }
            
            if (dataSource === 'pdf') {
                riskFlags.push({ type: 'warning', text: 'PDF extraction requires manual effort - adds ' + sourceImpact + ' hours' });
            }
            if (templateReadiness === 'needsConversion') {
                riskFlags.push({ type: 'warning', text: 'Data needs conversion - adds ' + templateImpact + ' hours' });
            }
            if (dataQuality === 'needsCleansing') {
                riskFlags.push({ type: 'warning', text: 'Data cleansing required - adds ' + qualityImpact + ' hours' });
            }
        } else {
            document.getElementById('totalHours').innerText = '‚Äî';
            document.getElementById('additionalEffort').innerText = '‚Äî';
            document.getElementById('executiveSummary').innerHTML = '<span class="placeholder-text">Select data source to continue</span>';
            return;
        }
        
        if (clientPm === 'no') {
            riskFlags.push({ type: 'warning', text: 'No dedicated PM - coordination overhead' });
        }
        if (clientChange === 'no') {
            riskFlags.push({ type: 'warning', text: 'No change management - adoption risk' });
        }
        
        document.getElementById('totalHours').innerText = totalHours.toLocaleString();
        document.getElementById('additionalEffort').innerText = additionalEffort.toLocaleString();
        document.getElementById('executiveSummary').innerHTML = `<strong>Executive Summary</strong><br>Core effort: ${coreHours} hrs. Additional ${additionalEffort} hrs (${Math.round((additionalEffort/coreHours)*100)}% increase).`;
        
        let flagsHtml = '';
        if (riskFlags.length > 0) {
            riskFlags.forEach(flag => {
                flagsHtml += `<div class="flag ${flag.type}"><i class="fas fa-${flag.type === 'critical' ? 'exclamation-triangle' : 'exclamation-circle'}"></i> ${flag.text}</div>`;
            });
        }
        document.getElementById('riskFlags').innerHTML = flagsHtml;
        
        const entityCount = document.getElementById('entityCount')?.value;
        const templateReadiness = document.getElementById('templateReadiness')?.value;
        const dataQuality = document.getElementById('dataQuality')?.value;
        const toolState = document.getElementById('toolState')?.value;
        
        const recs = getRecommendations({
            dataSource,
            toolState,
            templateReadiness,
            dataQuality,
            clientPm,
            clientChange,
            entityCount: entityCount ? parseInt(entityCount) : 0,
            contracts: contractsNum
        });
        
        if (recs.length > 0) {
            let recsHtml = '<strong>Strategic Recommendations</strong><ul>';
            recs.forEach(rec => {
                recsHtml += `<li>${rec}</li>`;
            });
            recsHtml += '</ul>';
            document.getElementById('recommendations').innerHTML = recsHtml;
            document.getElementById('recommendations').style.display = 'block';
        } else {
            document.getElementById('recommendations').style.display = 'none';
        }
        
        if (totalHours > 1000) {
            document.getElementById('riskLevel').innerText = 'CRITICAL';
        } else if (totalHours > 500) {
            document.getElementById('riskLevel').innerText = 'HIGH';
        } else if (totalHours > 300) {
            document.getElementById('riskLevel').innerText = 'MEDIUM';
        } else if (totalHours > 0) {
            document.getElementById('riskLevel').innerText = 'LOW';
        }
        
        // Store all data for Excel export
        window.excelData = {
            projectName: document.getElementById('projectName').value || 'Unnamed Project',
            projectDesc: document.getElementById('projectDescription').value || '',
            coreHours,
            totalHours,
            additionalEffort,
            breakdownItems,
            multiplierDetails,
            riskFlags,
            recommendations: recs
        };
    }

    function getRecommendations(params) {
        let recs = [];
        const { dataSource, toolState, templateReadiness, dataQuality, clientPm, clientChange, entityCount, contracts } = params;
        
        if (dataSource === 'pdf') {
            recs.push('Consider OCR technology or data entry services to automate PDF extraction. Manual extraction typically takes 2-3 minutes per page.');
        } else if (dataSource === 'excel') {
            recs.push('Validate Excel data structure during discovery. Create field mapping templates before project start to reduce transformation effort.');
        } else if (dataSource === 'migration') {
            if (toolState === 'notReady') {
                recs.push(`Tool readiness is critical. Schedule a ${entityCount > 20 ? '6-8' : '4-6'} week tool readiness sprint before full project start.`);
                recs.push(`With ${entityCount} entities, pilot 2-3 entities first to refine migration approach.`);
            } else if (toolState === 'none') {
                recs.push('No migration tool exists. Evaluate commercial migration tools or build a reusable framework - could reduce effort by 40-50%.');
            } else if (toolState === 'needsConfig') {
                recs.push('Ensure tool vendor provides configuration documentation and sample mappings to streamline setup.');
            }
        }
        
        if (templateReadiness === 'needsConversion') {
            recs.push('Pre-convert data to Nakisa templates during sales cycle to avoid 1.5x conversion multiplier.');
        }
        if (dataQuality === 'needsCleansing') {
            recs.push('Run a 2-3 day data quality assessment before migration to identify issues early.');
        }
        if (clientPm === 'no') {
            recs.push('Assign dedicated client PM to handle coordination - reduces overhead by ~10%.');
        }
        if (clientChange === 'no') {
            recs.push('Include change management and end-user training in scope to ensure adoption.');
        }
        if (contracts > 5000) {
            recs.push('High contract volume detected. Consider phased go-live by portfolio or region.');
        }
        
        return recs;
    }

    document.getElementById('excelBtn').addEventListener('click', function() {
        const data = window.excelData;
        if (!data || data.totalHours === 0) {
            alert('Please configure project parameters first');
            return;
        }

        // Create worksheet data with proper 3-column format
        const wbData = [
            ['SCOPEX - STATEMENT OF WORK ESTIMATOR', '', ''],
            ['Generated:', new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' }), ''],
            ['Project:', data.projectName, ''],
            ['Description:', data.projectDesc, ''],
            ['', '', ''],
            ['EXECUTIVE SUMMARY', '', ''],
            ['Total Estimated Hours', data.totalHours, '100%'],
            ['Core Project Hours', data.coreHours, Math.round((data.coreHours / data.totalHours) * 100) + '%'],
            ['Additional Effort', data.additionalEffort, Math.round((data.additionalEffort / data.totalHours) * 100) + '%'],
            ['', '', ''],
            ['DETAILED BREAKDOWN', '', ''],
            ['Item', 'Hours', '% of Total']
        ];

        // Add breakdown items
        data.breakdownItems.forEach(item => {
            wbData.push([
                item.item,
                item.hours,
                Math.round((item.hours / data.totalHours) * 100) + '%'
            ]);
        });

        wbData.push(['', '', '']);
        wbData.push(['MULTIPLIER IMPACTS', '', '']);
        wbData.push(['Item', 'Additional Hours', '% of Total']);

        // Add multiplier impacts
        data.multiplierDetails.forEach(item => {
            wbData.push([
                item.item,
                item.hours,
                Math.round((item.hours / data.totalHours) * 100) + '%'
            ]);
        });

        wbData.push(['', '', '']);
        wbData.push(['RISK FACTORS', '', '']);
        
        // Add risk flags
        if (data.riskFlags.length > 0) {
            data.riskFlags.forEach(flag => {
                wbData.push([flag.text, '', '']);
            });
        } else {
            wbData.push(['No significant risk factors identified', '', '']);
        }

        wbData.push(['', '', '']);
        wbData.push(['RECOMMENDATIONS', '', '']);
        
        // Add recommendations
        if (data.recommendations.length > 0) {
            data.recommendations.forEach(rec => {
                wbData.push([rec, '', '']);
            });
        } else {
            wbData.push(['No specific recommendations - project is well-structured', '', '']);
        }

        // Create workbook and worksheet
        const wb = XLSX.utils.book_new();
        const ws = XLSX.utils.aoa_to_sheet(wbData);

        // Set column widths
        ws['!cols'] = [
            { wch: 50 }, // Item column
            { wch: 15 }, // Hours column
            { wch: 10 }  // Percentage column
        ];

        // Add styling information (will be applied in Excel)
        // This creates a more structured format

        XLSX.utils.book_append_sheet(wb, ws, 'ScopeX Estimate');

        const filename = `ScopeX_${data.projectName.replace(/\s+/g, '_')}_${new Date().toISOString().slice(0,10)}.xlsx`;
        XLSX.writeFile(wb, filename);
    });

    toggleMigrationSection();
</script>
</body>
</html>