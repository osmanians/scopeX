<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ScopeX ¬∑ SOW Estimator</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    
    <!-- Libraries -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.2/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            font-family: 'Plus Jakarta Sans', sans-serif;
            min-height: 100vh;
            padding: 2rem;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 30px;
            padding: 1.2rem 2rem;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 20px;
            box-shadow: 0 20px 40px -15px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.3);
        }

        .logo-area {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .logo-icon {
            background: linear-gradient(135deg, #667eea, #764ba2);
            width: 60px;
            height: 60px;
            border-radius: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 2.2rem;
            box-shadow: 0 10px 20px -5px rgba(102, 126, 234, 0.4);
        }

        .title h1 {
            font-weight: 800;
            font-size: 2.2rem;
            background: linear-gradient(135deg, #2d3748, #1a202c);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .title p {
            font-weight: 500;
            font-size: 0.9rem;
            color: #718096;
        }

        .project-badge {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
            padding: 0.75rem 2rem;
            border-radius: 40px;
            font-weight: 600;
            font-size: 1rem;
            box-shadow: 0 10px 20px -5px rgba(72, 187, 120, 0.4);
            max-width: 450px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .project-info-bar {
            background: white;
            border-radius: 30px;
            padding: 2rem;
            margin-bottom: 2rem;
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
            box-shadow: 0 15px 30px -10px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .project-field {
            flex: 1;
            min-width: 280px;
        }

        .project-field label {
            display: block;
            font-weight: 700;
            font-size: 0.8rem;
            color: #4a5568;
            margin-bottom: 0.5rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .project-field input {
            width: 100%;
            padding: 1rem 1.2rem;
            border: 2px solid #e2e8f0;
            border-radius: 20px;
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .project-field input:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .estimator-grid {
            display: grid;
            grid-template-columns: 1.2fr 0.8fr;
            gap: 24px;
            margin-bottom: 30px;
        }

        @media (max-width: 1200px) {
            .estimator-grid { grid-template-columns: 1fr; }
        }

        .card {
            background: white;
            border-radius: 30px;
            padding: 2rem;
            box-shadow: 0 20px 40px -15px rgba(0,0,0,0.15);
            border: 1px solid #e2e8f0;
        }

        .result-card {
            background: linear-gradient(135deg, #1a202c, #2d3748);
            border-radius: 30px;
            padding: 2rem;
            color: white;
            box-shadow: 0 25px 50px -12px rgba(0,0,0,0.25);
        }

        .card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 2rem;
            border-bottom: 2px solid #e2e8f0;
            padding-bottom: 1.5rem;
        }

        .card-header i {
            font-size: 2rem;
            color: #667eea;
        }

        .card-header h2 {
            font-weight: 700;
            font-size: 1.4rem;
            color: #2d3748;
        }

        .result-card .card-header {
            border-bottom-color: rgba(255,255,255,0.1);
        }

        .result-card .card-header h2 {
            color: white;
        }

        .result-card .card-header i {
            color: #fbbf24;
        }

        .input-row {
            display: flex;
            flex-direction: column;
            margin-bottom: 1.5rem;
        }

        .input-row label {
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 8px;
            color: #4a5568;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .input-row input, .input-row select {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 16px;
            padding: 1rem 1.2rem;
            font-family: 'Plus Jakarta Sans', sans-serif;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .input-row input:focus, .input-row select:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .row-flex {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .conditional-section {
            background: #f7fafc;
            border-radius: 24px;
            padding: 1.5rem;
            margin: 1.5rem 0;
            border: 2px dashed #cbd5e0;
        }

        .section-tag {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            padding: 6px 16px;
            border-radius: 40px;
            font-size: 0.8rem;
            font-weight: 700;
            display: inline-block;
            margin-bottom: 1.5rem;
            letter-spacing: 0.05em;
        }

        .hidden {
            display: none;
        }

        .result-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 2rem;
        }

        .hours-big {
            font-size: 5rem;
            font-weight: 800;
            line-height: 1;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .hours-label {
            font-size: 1rem;
            opacity: 0.7;
            font-weight: 500;
        }

        .tier-tag {
            padding: 8px 24px;
            border-radius: 40px;
            font-weight: 700;
            font-size: 1.1rem;
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(5px);
        }

        .dual-hours {
            display: flex;
            gap: 20px;
            margin: 2rem 0;
        }

        .dual-hours-item {
            flex: 1;
            background: rgba(255,255,255,0.08);
            border-radius: 20px;
            padding: 1.5rem;
            text-align: center;
            backdrop-filter: blur(5px);
        }

        .dual-hours-item .label {
            font-size: 0.9rem;
            opacity: 0.7;
            margin-bottom: 10px;
        }

        .dual-hours-item .value {
            font-size: 3rem;
            font-weight: 800;
            line-height: 1;
            background: linear-gradient(135deg, #fbbf24, #f59e0b);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .executive-summary {
            background: rgba(251, 191, 36, 0.1);
            border-radius: 20px;
            padding: 1.5rem;
            margin: 2rem 0;
            border-left: 6px solid #fbbf24;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .flag {
            padding: 1rem 1.5rem;
            border-radius: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
            font-weight: 500;
        }

        .flag.critical {
            background: rgba(239, 68, 68, 0.1);
            border-left: 6px solid #ef4444;
        }

        .flag.warning {
            background: rgba(251, 191, 36, 0.1);
            border-left: 6px solid #fbbf24;
        }

        .recommendation-box {
            background: rgba(16, 185, 129, 0.1);
            border-radius: 20px;
            padding: 1.5rem;
            margin: 2rem 0;
            border-left: 6px solid #10b981;
        }

        .btn-excel {
            background: linear-gradient(135deg, #48bb78, #38a169);
            border: none;
            border-radius: 40px;
            padding: 1.2rem 2rem;
            font-weight: 700;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            cursor: pointer;
            width: 100%;
            color: white;
            transition: all 0.3s;
            border: 1px solid rgba(255,255,255,0.3);
            box-shadow: 0 15px 30px -10px rgba(72, 187, 120, 0.4);
        }

        .btn-excel:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 40px -10px rgba(72, 187, 120, 0.5);
        }

        footer {
            margin-top: 3rem;
            text-align: center;
            color: rgba(255,255,255,0.7);
            font-size: 0.9rem;
        }

        .placeholder-text {
            opacity: 0.6;
            font-style: italic;
        }
    </style>
</head>
<body>
<div class="container">
    <!-- Header -->
    <div class="header">
        <div class="logo-area">
            <div class="logo-icon">
                <i class="fas fa-compass"></i>
            </div>
            <div class="title">
                <h1>ScopeX</h1>
                <p>SOW Estimator</p>
            </div>
        </div>
        <div class="project-badge" id="projectBadge">
            <i class="fas fa-pen" style="margin-right: 8px;"></i>
            <span id="projectDisplay">Enter project details below</span>
        </div>
    </div>

    <!-- Project Info Bar -->
    <div class="project-info-bar">
        <div class="project-field">
            <label><i class="fas fa-file-signature"></i> PROJECT NAME</label>
            <input type="text" id="projectName" placeholder="e.g., LCBO" oninput="updateProjectDisplay()">
        </div>
        <div class="project-field">
            <label><i class="fas fa-align-left"></i> PROJECT DESCRIPTION</label>
            <input type="text" id="projectDescription" placeholder="e.g., IWMS / Upgrade / FI-AA to GL" oninput="updateProjectDisplay()">
        </div>
    </div>

    <!-- Main Grid -->
    <div class="estimator-grid">
        <!-- Input Panel -->
        <div class="card">
            <div class="card-header">
                <i class="fas fa-sliders-h"></i>
                <h2>Project configuration</h2>
            </div>

            <div class="input-row">
                <label><i class="fas fa-building"></i> Company codes</label>
                <input type="number" id="cocos" min="1" oninput="calculate()">
            </div>
            
            <div class="input-row">
                <label><i class="fas fa-chart-pie"></i> Asset classes</label>
                <input type="number" id="assetClasses" min="1" oninput="calculate()">
            </div>
            
            <div class="input-row">
                <label><i class="fas fa-file-contract"></i> Contract volume</label>
                <input type="number" id="contracts" min="1" oninput="calculate()">
            </div>

            <div class="row-flex">
                <div class="input-row">
                    <label><i class="fas fa-balance-scale"></i> Determination</label>
                    <select id="determination" onchange="calculate()">
                        <option value="">‚Äî Select ‚Äî</option>
                        <option value="Standard">Standard</option>
                        <option value="Custom">Custom</option>
                    </select>
                </div>
                <div class="input-row">
                    <label><i class="fas fa-globe"></i> Accounting</label>
                    <select id="gaap" onchange="calculate()">
                        <option value="">‚Äî Select ‚Äî</option>
                        <option value="Single">Single ( IFRS or GAAP)</option>
                        <option value="Dual">Dual (IFRS + GAAP)</option>
                        <option value="Triple">Triple</option>
                    </select>
                </div>
            </div>

            <div class="card-header" style="margin-top: 15px;">
                <i class="fas fa-database"></i>
                <h2>Data readiness</h2>
            </div>

            <div class="input-row">
                <label><i class="fas fa-source"></i> Primary data source</label>
                <select id="dataSource" onchange="toggleMigrationSection(); calculate()">
                    <option value="">‚Äî Select source ‚Äî</option>
                    <option value="templates">üìÅ Nakisa Native Templates</option>
                    <option value="pdf">üìÑ PDF Extraction</option>
                    <option value="excel">üìä Excel Export</option>
                    <option value="migration">üõ†Ô∏è Migration Tool</option>
                </select>
            </div>

            <div id="standardDataSection" style="display: none;">
                <div class="row-flex">
                    <div class="input-row">
                        <label><i class="fas fa-check-circle"></i> Template readiness</label>
                        <select id="templateReadiness" onchange="calculate()">
                            <option value="">‚Äî Select ‚Äî</option>
                            <option value="ready">Ready to load</option>
                            <option value="needsConversion">Needs conversion</option>
                        </select>
                    </div>
                    <div class="input-row">
                        <label><i class="fas fa-broom"></i> Data quality</label>
                        <select id="dataQuality" onchange="calculate()">
                            <option value="">‚Äî Select ‚Äî</option>
                            <option value="clean">Clean</option>
                            <option value="needsCleansing">Needs cleansing</option>
                        </select>
                    </div>
                </div>
            </div>

            <div id="migrationSection" class="conditional-section hidden">
                <div class="section-tag"><i class="fas fa-tools"></i> MIGRATION TOOL READINESS</div>
                
                <div class="input-row">
                    <label><i class="fas fa-cog"></i> Tool state</label>
                    <select id="toolState" onchange="calculate()">
                        <option value="">‚Äî Select ‚Äî</option>
                        <option value="mature">‚úÖ Mature - ready to use</option>
                        <option value="needsConfig">‚öôÔ∏è Needs configuration</option>
                        <option value="notReady">‚ö†Ô∏è NOT ready - PS defines strategy</option>
                        <option value="none">üö´ No tool - build from scratch</option>
                    </select>
                </div>

                <div class="input-row">
                    <label><i class="fas fa-cubes"></i> Entities to migrate</label>
                    <input type="number" id="entityCount" min="1" placeholder="e.g., 15" oninput="calculate()">
                </div>

                <div class="input-row">
                    <label><i class="fas fa-code-branch"></i> Transformation complexity</label>
                    <select id="transformComplexity" onchange="calculate()">
                        <option value="">‚Äî Select ‚Äî</option>
                        <option value="low">üìâ Low (10-20% need logic)</option>
                        <option value="medium">üìä Medium (30-50% need logic)</option>
                        <option value="high">üìà High (50%+ need complex logic)</option>
                    </select>
                </div>
            </div>

            <div class="card-header" style="margin-top: 15px;">
                <i class="fas fa-users-cog"></i>
                <h2>Team enablement</h2>
            </div>

            <div class="row-flex">
                <div class="input-row">
                    <label><i class="fas fa-user-tie"></i> Dedicated PM</label>
                    <select id="clientPm" onchange="calculate()">
                        <option value="">‚Äî Select ‚Äî</option>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                </div>
                <div class="input-row">
                    <label><i class="fas fa-chart-line"></i> Change management</label>
                    <select id="clientChange" onchange="calculate()">
                        <option value="">‚Äî Select ‚Äî</option>
                        <option value="yes">Yes</option>
                        <option value="no">No</option>
                    </select>
                </div>
            </div>
        </div>

        <!-- Results Panel -->
        <div class="result-card">
            <div class="result-header">
                <div>
                    <div class="hours-label">total estimated effort</div>
                    <div class="hours-big" id="totalHours">‚Äî</div>
                    <div class="hours-label">person-hours</div>
                </div>
                <div class="tier-tag" id="riskLevel">PENDING</div>
            </div>

            <div class="dual-hours">
                <div class="dual-hours-item">
                    <div class="label">core project</div>
                    <div class="value" id="coreProjectHours">‚Äî</div>
                    <div class="subtext">base + volume + complexity</div>
                </div>
                <div class="dual-hours-item">
                    <div class="label">additional effort</div>
                    <div class="value" id="additionalEffort">‚Äî</div>
                    <div class="subtext">data readiness + migration</div>
                </div>
            </div>

            <div class="executive-summary" id="executiveSummary">
                <span class="placeholder-text">Configure project parameters above</span>
            </div>

            <div class="risk-flags" id="riskFlags"></div>

            <div class="recommendation-box" id="recommendations" style="display: none;"></div>

            <button class="btn-excel" id="excelBtn">
                <i class="fas fa-file-excel"></i>
                Download Excel Analysis
            </button>
        </div>
    </div>

    <footer>
        ¬© 2024 ScopeX. All rights reserved.
    </footer>
</div>

<script>
    function updateProjectDisplay() {
        const projectName = document.getElementById('projectName').value;
        const projectDesc = document.getElementById('projectDescription').value;
        const badge = document.getElementById('projectDisplay');
        
        if (projectName && projectDesc) {
            badge.innerHTML = `${projectName} ¬∑ ${projectDesc}`;
        } else if (projectName) {
            badge.innerHTML = projectName;
        } else if (projectDesc) {
            badge.innerHTML = projectDesc;
        } else {
            badge.innerHTML = 'Enter project details below';
        }
    }

    // Core calculation constants - CORRECTED BASE HOURS
    const BASE_HOURS = {
        platform: 10,        // Reduced from 40 to 10
        projectMgmt: 30,      // Kept at 30
        architecture: 30,     // Kept at 30
        total: 70             // New total: 10 + 30 + 30 = 70
    };

    const RATES = {
        perCompanyCode: 2,
        perAssetClass: 2
    };

    const COMPLEXITY = {
        determination: { Standard: 20, Custom: 40 },
        accounting: { Single: 20, Dual: 40, Triple: 60 }
    };

    const DATA_READINESS = {
        template: { ready: 1.0, needsConversion: 1.5 },
        quality: { clean: 1.0, needsCleansing: 1.3 }
    };

    // HYBRID VOLUME CALCULATION - Logarithmic scaling for SaaS
    function calculateVolumeHours(contracts) {
        if (!contracts || contracts <= 0) return 0;
        
        const c = parseInt(contracts);
        
        // Tiered approach with diminishing returns
        if (c <= 500) {
            // First 500 contracts: 0.1 hrs each (setup, validation, sample testing)
            return Math.round(c * 0.1);
        } 
        else if (c <= 2000) {
            // 501-2000: 0.05 hrs each (bulk operations, template-based)
            return Math.round(500 * 0.1 + (c - 500) * 0.05);
        }
        else if (c <= 10000) {
            // 2001-10000: 0.02 hrs each (automated import tools)
            return Math.round(500 * 0.1 + 1500 * 0.05 + (c - 2000) * 0.02);
        }
        else if (c <= 50000) {
            // 10001-50000: 0.01 hrs each (enterprise bulk tools)
            return Math.round(500 * 0.1 + 1500 * 0.05 + 8000 * 0.02 + (c - 10000) * 0.01);
        }
        else {
            // 50000+: 0.005 hrs each (industrial-scale migration)
            return Math.round(500 * 0.1 + 1500 * 0.05 + 8000 * 0.02 + 40000 * 0.01 + (c - 50000) * 0.005);
        }
    }

    function calculateStrategyHours(toolState, entityCount, complexity) {
        if (!toolState || !entityCount || !complexity) return 0;
        
        const count = parseInt(entityCount) || 0;
        if (count === 0) return 0;
        
        if (toolState === 'mature') return 0;
        if (toolState === 'needsConfig') return 80;
        
        let basePerEntity = 0;
        if (toolState === 'notReady') basePerEntity = 35;
        if (toolState === 'none') basePerEntity = 60;
        
        let complexityMultiplier = 1.0;
        if (complexity === 'medium') complexityMultiplier = 1.5;
        if (complexity === 'high') complexityMultiplier = 2.2;
        
        let entityMultiplier = 1.0;
        if (count > 20) entityMultiplier = 1.3;
        if (count > 50) entityMultiplier = 1.6;
        
        const strategyHours = Math.round(
            count * basePerEntity * complexityMultiplier * entityMultiplier
        );
        
        const overhead = toolState === 'none' ? 200 : 120;
        return strategyHours + overhead;
    }

    function getExecutionMultiplier(toolState) {
        if (toolState === 'mature') return 1.0;
        if (toolState === 'needsConfig') return 1.3;
        if (toolState === 'notReady') return 2.2;
        if (toolState === 'none') return 3.0;
        return 1.0;
    }

    function getSourceMultiplier(dataSource) {
        if (dataSource === 'pdf') return 1.5;
        if (dataSource === 'excel') return 1.2;
        return 1.0;
    }

    window.toggleMigrationSection = function() {
        const dataSource = document.getElementById('dataSource').value;
        const standardSection = document.getElementById('standardDataSection');
        const migrationSection = document.getElementById('migrationSection');
        
        if (dataSource === 'migration') {
            standardSection.style.display = 'none';
            migrationSection.classList.remove('hidden');
        } else if (dataSource === 'templates' || dataSource === 'pdf' || dataSource === 'excel') {
            standardSection.style.display = 'block';
            migrationSection.classList.add('hidden');
        } else {
            standardSection.style.display = 'none';
            migrationSection.classList.add('hidden');
        }
    };

    function calculate() {
        const cocos = document.getElementById('cocos').value;
        const assets = document.getElementById('assetClasses').value;
        const contracts = document.getElementById('contracts').value;
        const determination = document.getElementById('determination').value;
        const gaap = document.getElementById('gaap').value;
        const dataSource = document.getElementById('dataSource').value;
        const clientPm = document.getElementById('clientPm').value;
        const clientChange = document.getElementById('clientChange').value;
        
        const cocosNum = cocos ? parseInt(cocos) : 0;
        const assetsNum = assets ? parseInt(assets) : 0;
        const contractsNum = contracts ? parseInt(contracts) : 0;
        
        let coreHours = 0;
        let hasBasicInputs = false;
        let breakdownItems = [];
        
        // Base platform - now 70 total (10 platform + 30 PM + 30 architecture)
        coreHours = BASE_HOURS.total;
        breakdownItems.push({
            item: 'Base Platform',
            hours: BASE_HOURS.total
        });
        
        if (cocosNum > 0 || assetsNum > 0 || contractsNum > 0 || determination || gaap) {
            hasBasicInputs = true;
            
            // Company codes (linear)
            if (cocosNum > 0) {
                const hrs = cocosNum * RATES.perCompanyCode;
                coreHours += hrs;
                breakdownItems.push({
                    item: `${cocosNum} Company Code${cocosNum > 1 ? 's' : ''}`,
                    hours: hrs
                });
            }
            
            // Asset classes (linear)
            if (assetsNum > 0) {
                const hrs = assetsNum * RATES.perAssetClass;
                coreHours += hrs;
                breakdownItems.push({
                    item: `${assetsNum} Asset Class${assetsNum > 1 ? 'es' : ''}`,
                    hours: hrs
                });
            }
            
            // Contracts (HYBRID - logarithmic scaling)
            if (contractsNum > 0) {
                const hrs = calculateVolumeHours(contractsNum);
                coreHours += hrs;
                breakdownItems.push({
                    item: `${contractsNum.toLocaleString()} Contracts`,
                    hours: hrs
                });
            }
            
            // Determination (fixed)
            if (determination) {
                const hrs = COMPLEXITY.determination[determination] || 0;
                coreHours += hrs;
                breakdownItems.push({
                    item: `${determination} Determination`,
                    hours: hrs
                });
            }
            
            // Accounting (fixed)
            if (gaap) {
                const hrs = COMPLEXITY.accounting[gaap] || 0;
                coreHours += hrs;
                breakdownItems.push({
                    item: `${gaap} Accounting`,
                    hours: hrs
                });
            }
        }
        
        document.getElementById('coreProjectHours').innerText = coreHours > 0 ? coreHours.toLocaleString() : '‚Äî';
        
        if (!hasBasicInputs) {
            document.getElementById('totalHours').innerText = '‚Äî';
            document.getElementById('additionalEffort').innerText = '‚Äî';
            document.getElementById('executiveSummary').innerHTML = '<span class="placeholder-text">Configure project parameters above</span>';
            document.getElementById('riskFlags').innerHTML = '';
            document.getElementById('recommendations').style.display = 'none';
            document.getElementById('riskLevel').innerText = 'PENDING';
            return;
        }

        let totalHours = coreHours;
        let additionalEffort = 0;
        let riskFlags = [];
        let multiplierDetails = [];
        let strategyHours = 0;
        
        if (dataSource === 'migration') {
            const toolState = document.getElementById('toolState').value;
            const entityCount = document.getElementById('entityCount').value;
            const transformComplexity = document.getElementById('transformComplexity').value;
            
            if (!toolState || !entityCount || !transformComplexity) {
                document.getElementById('totalHours').innerText = '‚Äî';
                document.getElementById('additionalEffort').innerText = '‚Äî';
                document.getElementById('executiveSummary').innerHTML = '<span class="placeholder-text">Complete migration tool selections</span>';
                return;
            }
            
            const entityCountNum = parseInt(entityCount) || 0;
            strategyHours = calculateStrategyHours(toolState, entityCount, transformComplexity);
            
            const executionMultiplier = getExecutionMultiplier(toolState);
            
            let teamMultiplier = 1.0;
            if (clientPm === 'no') teamMultiplier *= 1.1;
            if (clientChange === 'no') teamMultiplier *= 1.2;
            
            const baseForMultipliers = coreHours;
            const afterExecution = Math.round(baseForMultipliers * executionMultiplier);
            const executionImpact = afterExecution - baseForMultipliers;
            
            const afterTeam = Math.round(afterExecution * teamMultiplier);
            const teamImpact = afterTeam - afterExecution;
            
            const executionHours = afterTeam;
            totalHours = executionHours + strategyHours;
            additionalEffort = totalHours - coreHours;
            
            multiplierDetails.push({
                item: `Execution Multiplier (${toolState === 'notReady' ? 'Tool Not Ready' : toolState === 'none' ? 'No Tool' : toolState})`,
                hours: executionImpact
            });
            
            if (teamMultiplier > 1.0) {
                multiplierDetails.push({
                    item: 'Team Constraints',
                    hours: teamImpact
                });
            }
            
            multiplierDetails.push({
                item: 'Migration Strategy',
                hours: strategyHours
            });
            
            if (toolState === 'notReady') {
                riskFlags.push({ type: 'critical', text: `Migration tool not ready - requires ${strategyHours} hrs strategy for ${entityCountNum} entities` });
            } else if (toolState === 'none') {
                riskFlags.push({ type: 'critical', text: `No migration tool - custom build: ${strategyHours} hrs design` });
            }
            
        } else if (dataSource === 'templates' || dataSource === 'pdf' || dataSource === 'excel') {
            const templateReadiness = document.getElementById('templateReadiness').value;
            const dataQuality = document.getElementById('dataQuality').value;
            
            if (!templateReadiness || !dataQuality) {
                document.getElementById('totalHours').innerText = '‚Äî';
                document.getElementById('additionalEffort').innerText = '‚Äî';
                document.getElementById('executiveSummary').innerHTML = '<span class="placeholder-text">Complete data readiness selections</span>';
                return;
            }
            
            const templateMult = DATA_READINESS.template[templateReadiness];
            const qualityMult = DATA_READINESS.quality[dataQuality];
            const sourceMultiplier = getSourceMultiplier(dataSource);
            
            let teamMultiplier = 1.0;
            if (clientPm === 'no') teamMultiplier *= 1.1;
            if (clientChange === 'no') teamMultiplier *= 1.2;
            
            let currentHours = coreHours;
            
            const afterSource = Math.round(currentHours * sourceMultiplier);
            const sourceImpact = afterSource - currentHours;
            currentHours = afterSource;
            
            const afterTemplate = Math.round(currentHours * templateMult);
            const templateImpact = afterTemplate - currentHours;
            currentHours = afterTemplate;
            
            const afterQuality = Math.round(currentHours * qualityMult);
            const qualityImpact = afterQuality - currentHours;
            currentHours = afterQuality;
            
            const afterTeam = Math.round(currentHours * teamMultiplier);
            const teamImpact = afterTeam - currentHours;
            
            totalHours = afterTeam;
            additionalEffort = totalHours - coreHours;
            
            if (sourceMultiplier > 1.0) {
                multiplierDetails.push({
                    item: `Data Source (${dataSource === 'pdf' ? 'PDF Extraction' : 'Excel Export'})`,
                    hours: sourceImpact
                });
            }
            
            if (templateMult > 1.0) {
                multiplierDetails.push({
                    item: 'Template Conversion',
                    hours: templateImpact
                });
            }
            
            if (qualityMult > 1.0) {
                multiplierDetails.push({
                    item: 'Data Cleansing',
                    hours: qualityImpact
                });
            }
            
            if (teamMultiplier > 1.0) {
                multiplierDetails.push({
                    item: 'Team Constraints',
                    hours: teamImpact
                });
            }
            
            if (dataSource === 'pdf') {
                riskFlags.push({ type: 'warning', text: `PDF extraction requires manual effort - adds ${sourceImpact} hours` });
            }
            if (templateReadiness === 'needsConversion') {
                riskFlags.push({ type: 'warning', text: `Data needs conversion - adds ${templateImpact} hours` });
            }
            if (dataQuality === 'needsCleansing') {
                riskFlags.push({ type: 'warning', text: `Data cleansing required - adds ${qualityImpact} hours` });
            }
        } else {
            document.getElementById('totalHours').innerText = '‚Äî';
            document.getElementById('additionalEffort').innerText = '‚Äî';
            document.getElementById('executiveSummary').innerHTML = '<span class="placeholder-text">Select data source to continue</span>';
            return;
        }
        
        if (clientPm === 'no') {
            riskFlags.push({ type: 'warning', text: 'No dedicated PM - coordination overhead' });
        }
        if (clientChange === 'no') {
            riskFlags.push({ type: 'warning', text: 'No change management - adoption risk' });
        }
        
        document.getElementById('totalHours').innerText = totalHours.toLocaleString();
        document.getElementById('additionalEffort').innerText = additionalEffort.toLocaleString();
        
        // Calculate percentage increase
        const percentIncrease = Math.round((additionalEffort / coreHours) * 100);
        document.getElementById('executiveSummary').innerHTML = `<strong>Executive Summary</strong><br>Core effort: ${coreHours} hrs. Additional ${additionalEffort} hrs (${percentIncrease}% increase).`;
        
        let flagsHtml = '';
        if (riskFlags.length > 0) {
            riskFlags.forEach(flag => {
                flagsHtml += `<div class="flag ${flag.type}"><i class="fas fa-${flag.type === 'critical' ? 'exclamation-triangle' : 'exclamation-circle'}"></i> ${flag.text}</div>`;
            });
        }
        document.getElementById('riskFlags').innerHTML = flagsHtml;
        
        const entityCount = document.getElementById('entityCount')?.value;
        const templateReadiness = document.getElementById('templateReadiness')?.value;
        const dataQuality = document.getElementById('dataQuality')?.value;
        const toolState = document.getElementById('toolState')?.value;
        
        const recs = getRecommendations({
            dataSource,
            toolState,
            templateReadiness,
            dataQuality,
            clientPm,
            clientChange,
            entityCount: entityCount ? parseInt(entityCount) : 0,
            contracts: contractsNum
        });
        
        if (recs.length > 0) {
            let recsHtml = '<strong>Strategic Recommendations</strong><ul>';
            recs.forEach(rec => {
                recsHtml += `<li>${rec}</li>`;
            });
            recsHtml += '</ul>';
            document.getElementById('recommendations').innerHTML = recsHtml;
            document.getElementById('recommendations').style.display = 'block';
        } else {
            document.getElementById('recommendations').style.display = 'none';
        }
        
        if (totalHours > 1000) {
            document.getElementById('riskLevel').innerText = 'CRITICAL';
        } else if (totalHours > 500) {
            document.getElementById('riskLevel').innerText = 'HIGH';
        } else if (totalHours > 300) {
            document.getElementById('riskLevel').innerText = 'MEDIUM';
        } else if (totalHours > 0) {
            document.getElementById('riskLevel').innerText = 'LOW';
        }
        
        window.excelData = {
            projectName: document.getElementById('projectName').value || 'Unnamed Project',
            projectDesc: document.getElementById('projectDescription').value || '',
            coreHours,
            totalHours,
            additionalEffort,
            breakdownItems,
            multiplierDetails,
            riskFlags,
            recommendations: recs
        };
    }

    function getRecommendations(params) {
        let recs = [];
        const { dataSource, toolState, templateReadiness, dataQuality, clientPm, clientChange, entityCount, contracts } = params;
        
        if (dataSource === 'pdf') {
            recs.push('Consider OCR technology or data entry services to automate PDF extraction. Manual extraction typically takes 2-3 minutes per page.');
        } else if (dataSource === 'excel') {
            recs.push('Validate Excel data structure during discovery. Create field mapping templates before project start to reduce transformation effort.');
        } else if (dataSource === 'migration') {
            if (toolState === 'notReady') {
                recs.push(`Tool readiness is critical. Schedule a ${entityCount > 20 ? '6-8' : '4-6'} week tool readiness sprint before full project start.`);
                recs.push(`With ${entityCount} entities, pilot 2-3 entities first to refine migration approach.`);
            } else if (toolState === 'none') {
                recs.push('No migration tool exists. Evaluate commercial migration tools or build a reusable framework - could reduce effort by 40-50%.');
            } else if (toolState === 'needsConfig') {
                recs.push('Ensure tool vendor provides configuration documentation and sample mappings to streamline setup.');
            }
        }
        
        if (templateReadiness === 'needsConversion') {
            recs.push('Pre-convert data to Nakisa templates during sales cycle to avoid 1.5x conversion multiplier.');
        }
        if (dataQuality === 'needsCleansing') {
            recs.push('Run a 2-3 day data quality assessment before migration to identify issues early.');
        }
        if (clientPm === 'no') {
            recs.push('Assign dedicated client PM to handle coordination - reduces overhead by ~10%.');
        }
        if (clientChange === 'no') {
            recs.push('Include change management and end-user training in scope to ensure adoption.');
        }
        if (contracts > 10000) {
            recs.push('High contract volume detected. Leverage bulk import templates and automated validation to minimize per-contract effort.');
        }
        
        return recs;
    }

    // WORLD-CLASS EXCEL DESIGN - NO WHITE TEXT, ALL BLACK TEXT FOR READABILITY
    document.getElementById('excelBtn').addEventListener('click', function() {
        const data = window.excelData;
        if (!data || data.totalHours === 0) {
            alert('Please configure project parameters first');
            return;
        }

        // Create HTML table with stunning ScopeX design - ALL TEXT BLACK FOR READABILITY
        let html = `
            <html>
            <head>
                <meta charset="UTF-8">
                <title>ScopeX Estimate</title>
                <style>
                    body { 
                        font-family: 'Segoe UI', 'Calibri', 'Arial', sans-serif; 
                        margin: 30px; 
                        background-color: #f8fafc;
                        color: #1a1f3c;
                    }
                    
                    /* Master header with gradient - text black for readability */
                    .master-header {
                        background: linear-gradient(135deg, #e0e7ff 0%, #c7d2fe 100%);
                        color: #1a1f3c !important;
                        padding: 25px 30px;
                        border-radius: 16px 16px 16px 16px;
                        margin-bottom: 25px;
                        box-shadow: 0 15px 30px -10px rgba(0,0,0,0.15);
                        border-left: 6px solid #fbbf24;
                    }
                    
                    .master-header h1 {
                        font-size: 32px;
                        font-weight: 700;
                        margin: 0;
                        letter-spacing: -0.5px;
                        display: flex;
                        align-items: center;
                        gap: 15px;
                        color: #1a1f3c !important;
                    }
                    
                    .master-header h1 span {
                        background: rgba(26, 31, 60, 0.1);
                        padding: 8px 18px;
                        border-radius: 40px;
                        font-size: 16px;
                        font-weight: 500;
                        color: #1a1f3c;
                    }
                    
                    .master-header .meta {
                        display: flex;
                        justify-content: space-between;
                        margin-top: 15px;
                        color: #2d3748;
                        font-size: 14px;
                    }
                    
                    .master-header .badge {
                        background: linear-gradient(135deg, #fbbf24, #f59e0b);
                        color: #1a1f3c;
                        padding: 6px 18px;
                        border-radius: 40px;
                        font-weight: 700;
                        font-size: 14px;
                    }
                    
                    /* Project info card */
                    .project-card {
                        background: white;
                        border-radius: 16px;
                        padding: 20px 25px;
                        margin-bottom: 25px;
                        box-shadow: 0 8px 20px -8px rgba(0,0,0,0.1);
                        border: 1px solid #e9eef2;
                        display: flex;
                        flex-wrap: wrap;
                        gap: 30px;
                    }
                    
                    .project-info-item {
                        flex: 1;
                        min-width: 200px;
                    }
                    
                    .project-info-item .label {
                        font-size: 12px;
                        text-transform: uppercase;
                        letter-spacing: 0.5px;
                        color: #64748b;
                        margin-bottom: 5px;
                    }
                    
                    .project-info-item .value {
                        font-size: 18px;
                        font-weight: 600;
                        color: #1a1f3c;
                    }
                    
                    /* Table styles */
                    table { 
                        border-collapse: collapse; 
                        width: 100%; 
                        margin-bottom: 25px;
                        box-shadow: 0 8px 20px -8px rgba(0,0,0,0.08);
                        border-radius: 16px;
                        overflow: hidden;
                    }
                    
                    th { 
                        background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
                        color: #1a1f3c !important; 
                        font-weight: 700; 
                        text-align: left; 
                        padding: 16px 20px; 
                        font-size: 16px;
                        letter-spacing: 0.3px;
                        border-bottom: 2px solid #9aa8b9;
                    }
                    
                    th i { margin-right: 8px; color: #4c51bf; }
                    
                    td { 
                        padding: 14px 20px; 
                        border-bottom: 1px solid #e9eef2;
                        background-color: white;
                        font-size: 15px;
                        color: #1a1f3c;
                    }
                    
                    tr:last-child td {
                        border-bottom: none;
                    }
                    
                    .section-header td { 
                        background: linear-gradient(135deg, #f8f0ff, #f0e6ff);
                        font-weight: 700;
                        color: #2d1f4a;
                        border-bottom: 2px solid #cbd5e0;
                    }
                    
                    .total-row { 
                        background-color: #f1f5f9; 
                        font-weight: 700; 
                    }
                    
                    .total-row td {
                        background-color: #f1f5f9;
                        border-top: 2px solid #94a3b8;
                    }
                    
                    .highlight-number {
                        font-weight: 700;
                        color: #2d1f4a;
                    }
                    
                    .percentage {
                        color: #64748b;
                        font-weight: 500;
                    }
                    
                    /* Risk flags - all text dark */
                    .risk-critical {
                        background: #fee2e2;
                        border-left: 6px solid #ef4444;
                        color: #7f1d1d;
                    }
                    
                    .risk-warning {
                        background: #fef3c7;
                        border-left: 6px solid #fbbf24;
                        color: #92400e;
                    }
                    
                    /* Footer - dark text for readability */
                    .footer { 
                        margin-top: 30px; 
                        padding: 20px;
                        text-align: center;
                        background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
                        color: #1a1f3c;
                        border-radius: 16px;
                        box-shadow: 0 8px 20px -8px rgba(0,0,0,0.1);
                    }
                    
                    .footer p {
                        margin: 5px 0;
                        color: #1a1f3c;
                    }
                    
                    .footer small {
                        opacity: 0.8;
                        font-size: 11px;
                        color: #2d3748;
                    }
                </style>
            </head>
            <body>
                <!-- Master Header - NO CONFIDENTIAL TAG -->
                <div class="master-header">
                    <h1>
                        <i class="fas fa-compass" style="font-size: 32px; color: #4c51bf;"></i>
                        SCOPEX ¬∑ SOW ESTIMATOR
                    </h1>
                    <div class="meta">
                        <div>Generated: ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</div>
                        <div class="badge">Estimate ID: SOW-${Math.random().toString(36).substr(2, 9).toUpperCase()}</div>
                    </div>
                </div>
                
                <!-- Project Info Card -->
                <div class="project-card">
                    <div class="project-info-item">
                        <div class="label">Project Name</div>
                        <div class="value">${data.projectName}</div>
                    </div>
                    <div class="project-info-item">
                        <div class="label">Description</div>
                        <div class="value">${data.projectDesc}</div>
                    </div>
                    <div class="project-info-item">
                        <div class="label">Risk Level</div>
                        <div class="value" style="color: ${data.totalHours > 1000 ? '#b91c1c' : data.totalHours > 500 ? '#b45309' : '#047857'}; font-weight: 700;">
                            ${data.totalHours > 1000 ? 'CRITICAL' : data.totalHours > 500 ? 'HIGH' : data.totalHours > 300 ? 'MEDIUM' : 'LOW'}
                        </div>
                    </div>
                </div>
                
                <!-- Executive Summary Table -->
                <table>
                    <tr><th colspan="3"><i class="fas fa-chart-pie"></i> EXECUTIVE SUMMARY</th></tr>
                    <tr>
                        <td width="300"><strong>Total Estimated Hours</strong></td>
                        <td width="150" class="highlight-number">${data.totalHours.toLocaleString()}</td>
                        <td class="percentage">100%</td>
                    </tr>
                    <tr>
                        <td><strong>Core Project Hours</strong></td>
                        <td class="highlight-number">${data.coreHours.toLocaleString()}</td>
                        <td class="percentage">${Math.round((data.coreHours / data.totalHours) * 100)}%</td>
                    </tr>
                    <tr>
                        <td><strong>Additional Effort</strong></td>
                        <td class="highlight-number">${data.additionalEffort.toLocaleString()}</td>
                        <td class="percentage">${Math.round((data.additionalEffort / data.totalHours) * 100)}%</td>
                    </tr>
                </table>
                
                <!-- Detailed Breakdown Table -->
                <table>
                    <tr><th colspan="3"><i class="fas fa-tasks"></i> DETAILED BREAKDOWN</th></tr>
                    <tr style="background: #f1f5f9;">
                        <th width="300">Item</th>
                        <th width="150">Hours</th>
                        <th>% of Total</th>
                    </tr>
        `;

        // Add breakdown items with alternating row colors
        data.breakdownItems.forEach((item, index) => {
            const percent = Math.round((item.hours / data.totalHours) * 100);
            const rowStyle = index % 2 === 0 ? 'background: white;' : 'background: #fafbfc;';
            html += `<tr style="${rowStyle}"><td>${item.item}</td><td class="highlight-number">${item.hours.toLocaleString()}</td><td class="percentage">${percent}%</td></tr>`;
        });

        html += `
                </table>
                
                <!-- Multiplier Impacts Table -->
                <table>
                    <tr><th colspan="3"><i class="fas fa-chart-line"></i> MULTIPLIER IMPACTS</th></tr>
                    <tr style="background: #f1f5f9;">
                        <th width="300">Factor</th>
                        <th width="150">Additional Hours</th>
                        <th>% of Total</th>
                    </tr>
        `;

        // Add multiplier impacts with alternating row colors
        data.multiplierDetails.forEach((item, index) => {
            const percent = Math.round((item.hours / data.totalHours) * 100);
            const rowStyle = index % 2 === 0 ? 'background: white;' : 'background: #fafbfc;';
            html += `<tr style="${rowStyle}"><td>${item.item}</td><td class="highlight-number">${item.hours.toLocaleString()}</td><td class="percentage">${percent}%</td></tr>`;
        });

        html += `
                </table>
                
                <!-- Risk Factors Table -->
                <table>
                    <tr><th colspan="3"><i class="fas fa-exclamation-triangle"></i> RISK FACTORS</th></tr>
        `;

        // Add risk factors with color coding - all text dark
        if (data.riskFlags.length > 0) {
            data.riskFlags.forEach(flag => {
                const riskClass = flag.type === 'critical' ? 'risk-critical' : 'risk-warning';
                html += `<tr><td colspan="3" style="padding: 16px 20px;" class="${riskClass}"><i class="fas fa-${flag.type === 'critical' ? 'exclamation-circle' : 'exclamation-triangle'}" style="margin-right: 10px;"></i> ${flag.text}</td></tr>`;
            });
        } else {
            html += `<tr><td colspan="3" style="padding: 16px 20px; background: #d1fae5;"><i class="fas fa-check-circle" style="color: #059669; margin-right: 10px;"></i> No significant risk factors identified</td></tr>`;
        }

        html += `
                </table>
                
                <!-- Impact Analysis Table -->
                <table>
                    <tr><th colspan="3"><i class="fas fa-analytics"></i> IMPACT ANALYSIS</th></tr>
        `;

        // Add impact analysis
        data.multiplierDetails.forEach(item => {
            const percentOfCore = Math.round((item.hours / data.coreHours) * 100);
            html += `<tr><td colspan="3" style="padding: 14px 20px;"><i class="fas fa-arrow-right" style="color: #667eea; margin-right: 10px;"></i> ${item.item} adds <strong>${item.hours.toLocaleString()} hours</strong> (${percentOfCore}% to core)</td></tr>`;
        });

        html += `
                </table>
                
                <!-- Recommendations Table -->
                <table>
                    <tr><th colspan="3"><i class="fas fa-lightbulb"></i> STRATEGIC RECOMMENDATIONS</th></tr>
        `;

        // Add recommendations
        if (data.recommendations.length > 0) {
            data.recommendations.forEach(rec => {
                html += `<tr><td colspan="3" style="padding: 14px 20px;"><i class="fas fa-check-circle" style="color: #059669; margin-right: 10px;"></i> ${rec}</td></tr>`;
            });
        } else {
            html += `<tr><td colspan="3" style="padding: 14px 20px;">No specific recommendations - project is well-structured</td></tr>`;
        }

        html += `
                </table>
                
                <!-- Footer -->
                <div class="footer">
                    <p><i class="fas fa-compass" style="margin-right: 8px;"></i> GENERATED BY SCOPEX</p>
                    <p>¬© 2024 ScopeX. All rights reserved.</p>
                </div>
            </body>
            </html>
        `;

        // Generate filename
        const safeProjectName = (data.projectName || 'Project').replace(/[^a-z0-9]/gi, '_');
        const dateStr = new Date().toISOString().slice(0,10);
        const filename = `ScopeX_${safeProjectName}_${dateStr}.xls`;
        
        // Create and save blob
        const blob = new Blob([html], { type: 'application/vnd.ms-excel' });
        saveAs(blob, filename);
    });

    toggleMigrationSection();
</script>
</body>
</html>
